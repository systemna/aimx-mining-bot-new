from flask import Flask, request, jsonify, render_template
import requests
import os
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton
import asyncio

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
API_URL = os.getenv("BLOCKCHAIN_API_URL")  # API Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ù„Ø°ÙƒÙŠ

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙˆØª
bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

# Ø¥Ø¹Ø¯Ø§Ø¯ Flask Ù„ØªØ´ØºÙŠÙ„ API ÙˆØ§Ù„ÙˆØ§Ø¬Ù‡Ø©
app = Flask(__name__)
users = {}  # Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø³ÙŠØ·Ø© Ù„Ø­ÙØ¸ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†

@app.route("/")
def dashboard():
    return render_template("index.html", users=users)

@app.route("/mine", methods=["POST"])
def mine():
    data = request.json
    user_id = str(data.get("user_id"))
    amount = 10  # ÙƒÙ…ÙŠØ© Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    
    if user_id not in users:
        users[user_id] = 0
    
    users[user_id] += amount
    return jsonify({"message": "Mining successful", "amount": amount, "balance": users[user_id]})

@app.route("/balance/<user_id>", methods=["GET"])
def balance(user_id):
    balance = users.get(user_id, 0)
    return jsonify({"balance": balance})

# Ø¥Ø¹Ø¯Ø§Ø¯ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙÙŠ ØªÙ„ÙŠØ¬Ø±Ø§Ù…
keyboard = ReplyKeyboardMarkup(resize_keyboard=True)
keyboard.add(KeyboardButton("ğŸ› Ø§Ù„Ø­Ø³Ø§Ø¨"), KeyboardButton("â› Ø§Ù„ØªØ¹Ø¯ÙŠÙ†"))

@dp.message_handler(commands=['start'])
async def start(message: types.Message):
    await message.reply("ğŸ‘‹ Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ø¨ÙˆØª ØªØ¹Ø¯ÙŠÙ† AIMX! Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø£Ø¯Ù†Ø§Ù‡ Ù„Ù„ØªØ­ÙƒÙ….", reply_markup=keyboard)

@dp.message_handler(lambda message: message.text == "â› Ø§Ù„ØªØ¹Ø¯ÙŠÙ†")
async def mine_command(message: types.Message):
    user_id = message.from_user.id
    response = requests.post(f"{API_URL}/mine", json={"user_id": user_id})
    if response.status_code == 200:
        data = response.json()
        await message.reply(f"ğŸ‰ Ù„Ù‚Ø¯ Ø­ØµÙ„Øª Ø¹Ù„Ù‰ {data['amount']} AIMX! Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: {data['balance']} AIMX")
    else:
        await message.reply("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ†.")

@dp.message_handler(lambda message: message.text == "ğŸ› Ø§Ù„Ø­Ø³Ø§Ø¨")
async def balance_command(message: types.Message):
    user_id = message.from_user.id
    response = requests.get(f"{API_URL}/balance/{user_id}")
    if response.status_code == 200:
        data = response.json()
        await message.reply(f"ğŸ’° Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ: {data['balance']} AIMX")
    else:
        await message.reply("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¬Ù„Ø¨ Ø§Ù„Ø±ØµÙŠØ¯.")

async def main():
    await dp.start_polling()

if __name__ == "__main__":
    loop = asyncio.get_event_loop()
    loop.create_task(main())
    app.run(host="0.0.0.0", port=5000)
